-- 00. FUNÇÃO BÁSICA PARA ATUALIZAÇÃO AUTOMÁTICA DE TIMESTAMP (UPDATED_AT)
CREATE OR REPLACE FUNCTION public.set_updated_at()
RETURNS trigger
LANGUAGE plpgsql
AS $$
BEGIN
  NEW.updated_at =
now();
  RETURN NEW;
END;
$$;

- 1. PERFIL (Tabela de Dimensão)
CREATE TABLE public.perfil (
    id_perfil BIGSERIAL NOT
NULL,
    nome_perfil character
varying NOT NULL UNIQUE,
    created_at
timestamp with time zone NOT NULL DEFAULT now(),
    updated_at
timestamp with time zone NOT NULL DEFAULT now(),
    CONSTRAINT
perfil_pkey PRIMARY KEY (id_perfil)
);
CREATE TRIGGER trg_perfil_updated_at
BEFORE UPDATE ON public.perfil
FOR EACH ROW EXECUTE FUNCTION public.set_updated_at();

-- 2. USUARIO (Tabela de Acesso)
CREATE TABLE public.usuario (
    id_usuario BIGSERIAL NOT
NULL,
    email character
varying NOT NULL UNIQUE,
    nome character
varying,
    senha_hash text,
    id_perfil BIGINT
NOT NULL,
    created_at
timestamp with time zone NOT NULL DEFAULT now(),
    updated_at
timestamp with time zone NOT NULL DEFAULT now(),
    CONSTRAINT
usuario_pkey PRIMARY KEY (id_usuario),
    CONSTRAINT
usuario_id_perfil_fkey FOREIGN KEY (id_perfil) REFERENCES public.perfil(id_perfil)
);
CREATE TRIGGER trg_usuario_updated_at
BEFORE UPDATE ON public.usuario
FOR EACH ROW EXECUTE FUNCTION public.set_updated_at();

-- 3. COLABORADOR (Entidade de Pessoas)
CREATE TABLE public.colaborador (
    id_colaborador BIGSERIAL
NOT NULL,
    nome character
varying NOT NULL,
    matricula character
varying UNIQUE NOT NULL,
    cargo character
varying, -- Assumindo que 'cargo' é uma string simples aqui
    data_admissao date,
    status character
varying DEFAULT 'Ativo',
    id_gestor BIGINT,
-- FK Recursiva para GESTOR
    id_usuario BIGINT
UNIQUE, -- FK para login
    created_at
timestamp with time zone NOT NULL DEFAULT now(),
    updated_at
timestamp with time zone NOT NULL DEFAULT now(),
    CONSTRAINT
colaborador_pkey PRIMARY KEY (id_colaborador),
    CONSTRAINT
colaborador_id_usuario_fkey FOREIGN KEY (id_usuario) REFERENCES
public.usuario(id_usuario) ON DELETE SET NULL,
    CONSTRAINT
colaborador_id_gestor_fkey FOREIGN KEY (id_gestor) REFERENCES
public.colaborador(id_colaborador) ON DELETE SET NULL
);
CREATE INDEX idx_colaborador_gestor ON public.colaborador (id_gestor);
CREATE TRIGGER trg_colaborador_updated_at
BEFORE UPDATE ON public.colaborador
FOR EACH ROW EXECUTE FUNCTION public.set_updated_at();

-- 4. CICLO_DESEMPENHO (Base do Processo)
CREATE TABLE public.ciclo_desempenho (
    id_ciclo BIGSERIAL NOT
NULL,
    nome_ciclo character
varying NOT NULL UNIQUE,
    data_inicio date
NOT NULL,
    data_fim date NOT
NULL,
    status character
varying DEFAULT 'Rascunho',
    created_at
timestamp with time zone NOT NULL DEFAULT now(),
    updated_at
timestamp with time zone NOT NULL DEFAULT now(),
    CONSTRAINT
ciclo_desempenho_pkey PRIMARY KEY (id_ciclo)
);
CREATE TRIGGER trg_ciclo_desempenho_updated_at
BEFORE UPDATE ON public.ciclo_desemPENHO
FOR EACH ROW EXECUTE FUNCTION public.set_updated_at();

-- 5. CICLO_COLABORADOR (Junção Central N:M)
CREATE TABLE public.ciclo_colaborador (
    id_ciclo_colaborador
BIGSERIAL NOT NULL,
    id_ciclo BIGINT
NOT NULL,
    id_colaborador
BIGINT NOT NULL,
    recomendacao_experiencia
text,
    created_at
timestamp with time zone NOT NULL DEFAULT now(),
    updated_at
timestamp with time zone NOT NULL DEFAULT now(),
    CONSTRAINT
ciclo_colaborador_pkey PRIMARY KEY (id_ciclo_colaborador),
    CONSTRAINT
cc_id_ciclo_fkey FOREIGN KEY (id_ciclo) REFERENCES public.ciclo_desempenho(id_ciclo) ON DELETE CASCADE,
    CONSTRAINT
cc_id_colaborador_fkey FOREIGN KEY (id_colaborador) REFERENCES public.colaborador(id_colaborador) ON DELETE CASCADE,
    UNIQUE (id_ciclo,
id_colaborador)
);
CREATE TRIGGER trg_ciclo_colaborador_updated_at
BEFORE UPDATE ON public.ciclo_colaborador
FOR EACH ROW EXECUTE FUNCTION public.set_updated_at();

-- 6. COMPETENCIA (Itens de Avaliação)
CREATE TABLE public.competencia (
    id_competencia BIGSERIAL
NOT NULL,
    nome_competencia
character varying NOT NULL UNIQUE,
    descricao text,
    peso numeric NOT
NULL DEFAULT 1,
    created_at
timestamp with time zone NOT NULL DEFAULT now(),
    updated_at
timestamp with time zone NOT NULL DEFAULT now(),
    CONSTRAINT
competencia_pkey PRIMARY KEY (id_competencia)
);
CREATE TRIGGER trg_competencia_updated_at
BEFORE UPDATE ON public.competencia
FOR EACH ROW EXECUTE FUNCTION public.set_updated_at();

-- 7. META (Itens de Avaliação)
CREATE TABLE public.meta (
    id_meta BIGSERIAL NOT
NULL,
    nome_meta character
varying NOT NULL,
    descricao text,
    peso numeric NOT
NULL DEFAULT 1,
    created_at
timestamp with time zone NOT NULL DEFAULT now(),
    updated_at
timestamp with time zone NOT NULL DEFAULT now(),
    CONSTRAINT meta_pkey
PRIMARY KEY (id_meta)
);
CREATE TRIGGER trg_meta_updated_at
BEFORE UPDATE ON public.meta
FOR EACH ROW EXECUTE FUNCTION public.set_updated_at();

-- 8. AVALIACAO (Cabeçalho da Avaliação)
CREATE TABLE public.avaliacao (
    id_avaliacao BIGSERIAL
NOT NULL,
    pontuacao_merito
numeric,
    data_envio
timestamp with time zone,
    status character
varying,
    id_ciclo_colaborador
BIGINT NOT NULL,
    id_avaliador BIGINT
NOT NULL,
    created_at
timestamp with time zone NOT NULL DEFAULT now(),
    updated_at
timestamp with time zone NOT NULL DEFAULT now(),
    CONSTRAINT
avaliacao_pkey PRIMARY KEY (id_avaliacao),
    CONSTRAINT
avaliacao_id_cc_fkey FOREIGN KEY (id_ciclo_colaborador) REFERENCES
public.ciclo_colaborador(id_ciclo_colaborador) ON DELETE CASCADE,
    CONSTRAINT
avaliacao_id_avaliador_fkey FOREIGN KEY (id_avaliador) REFERENCES
public.colaborador(id_colaborador) ON DELETE SET NULL
);
CREATE TRIGGER trg_avaliacao_updated_at
BEFORE UPDATE ON public.avaliacao
FOR EACH ROW EXECUTE FUNCTION public.set_updated_at();

-- 9. PONTUACAO_COMPETENCIA (Junção N:M para Competência)
CREATE TABLE public.pontuacao_competencia (
    id_pont_comp
BIGSERIAL NOT NULL,
    nota_gestor numeric,
    nota_colaborador
numeric,
    nota_final numeric,
    id_avaliacao BIGINT
NOT NULL,
    id_competencia
BIGINT NOT NULL,
    created_at
timestamp with time zone NOT NULL DEFAULT now(),
    updated_at
timestamp with time zone NOT NULL DEFAULT now(),
    CONSTRAINT
pontuacao_competencia_pkey PRIMARY KEY (id_pont_comp),
    CONSTRAINT
pc_id_avaliacao_fkey FOREIGN KEY (id_avaliacao) REFERENCES public.avaliacao(id_avaliacao) ON DELETE CASCADE,
    CONSTRAINT
pc_id_competencia_fkey FOREIGN KEY (id_competencia) REFERENCES
public.competencia(id_competencia) ON DELETE CASCADE,
    UNIQUE (id_avaliacao,
id_competencia)
);
CREATE TRIGGER trg_pontuacao_competencia_updated_at
BEFORE UPDATE ON public.pontuacao_competencia
FOR EACH ROW EXECUTE FUNCTION public.set_updated_at();

-- 10. PONTUACAO_META (Junção N:M para Meta)
CREATE TABLE public.pontuacao_meta (
    id_pont_meta
BIGSERIAL NOT NULL,
    nota_gestor numeric,
    nota_final numeric,
    id_avaliacao BIGINT
NOT NULL,
    id_meta BIGINT
NOT NULL,
    created_at
timestamp with time zone NOT NULL DEFAULT now(),
    updated_at
timestamp with time zone NOT NULL DEFAULT now(),
    CONSTRAINT
pontuacao_meta_pkey PRIMARY KEY (id_pont_meta),
    CONSTRAINT
pm_id_avaliacao_fkey FOREIGN KEY (id_avaliacao) REFERENCES public.avaliacao(id_avaliacao) ON DELETE CASCADE,
    CONSTRAINT
pm_id_meta_fkey FOREIGN KEY (id_meta) REFERENCES public.meta(id_meta) ON DELETE CASCADE,
    UNIQUE (id_avaliacao,
id_meta)
);
CREATE TRIGGER trg_pontuacao_meta_updated_at
BEFORE UPDATE ON public.pontuacao_meta
FOR EACH ROW EXECUTE FUNCTION public.set_updated_at();

-- 11. NINE_BOX (Resultado Final)
CREATE TABLE public.nine_box (
    id_nine_box
BIGSERIAL NOT NULL,
    posicao_x character
varying NOT NULL, -- Potencial
    posicao_y character
varying NOT NULL, -- Desempenho
    id_ciclo_colaborador
BIGINT UNIQUE NOT NULL,
    created_at
timestamp with time zone NOT NULL DEFAULT now(),
    updated_at
timestamp with time zone NOT NULL DEFAULT now(),
    CONSTRAINT nine_box_pkey
PRIMARY KEY (id_nine_box),
    CONSTRAINT
nb_id_cc_fkey FOREIGN KEY (id_ciclo_colaborador) REFERENCES
public.ciclo_colaborador(id_ciclo_colaborador) ON DELETE CASCADE
);
CREATE TRIGGER trg_nine_box_updated_at
BEFORE UPDATE ON public.nine_box
FOR EACH ROW EXECUTE FUNCTION public.set_updated_at();

-- 12. FEEDBACK (Tabela de Eventos Contínuos)
CREATE TABLE public.feedback (
    id_feedback
BIGSERIAL NOT NULL,
    texto_feedback
text NOT NULL,
    data timestamp with
time zone NOT NULL DEFAULT now(),
    tipo character
varying, -- Ponto Forte/Melhoria
    id_colaborador
BIGINT NOT NULL, -- Receptor
    id_avaliador BIGINT
NOT NULL, -- Emissor
    created_at
timestamp with time zone NOT NULL DEFAULT now(),
    updated_at
timestamp with time zone NOT NULL DEFAULT now(),
    CONSTRAINT
feedback_pkey PRIMARY KEY (id_feedback),
    CONSTRAINT
feedback_id_colab_fkey FOREIGN KEY (id_colaborador) REFERENCES
public.colaborador(id_colaborador) ON DELETE CASCADE,
    CONSTRAINT
feedback_id_avaliador_fkey FOREIGN KEY (id_avaliador) REFERENCES
public.colaborador(id_colaborador) ON DELETE CASCADE
);
CREATE TRIGGER trg_feedback_updated_at
BEFORE UPDATE ON public.feedback
FOR EACH ROW EXECUTE FUNCTION public.set_updated_at();

-- 13. TRILHA_CARREIRA
CREATE TABLE public.trilha_carreira (
    id_trilha BIGSERIAL
NOT NULL,
    nome_trilha character
varying NOT NULL UNIQUE,
    criterios_elegibilidade
text, -- RF 2.3
    created_at
timestamp with time zone NOT NULL DEFAULT now(),
    updated_at
timestamp with time zone NOT NULL DEFAULT now(),
    CONSTRAINT
trilha_carreira_pkey PRIMARY KEY (id_trilha)
);
CREATE TRIGGER trg_trilha_carreira_updated_at
BEFORE UPDATE ON public.trilha_carreira
FOR EACH ROW EXECUTE FUNCTION public.set_updated_at();

-- 14. COLABORADOR_TRILHA (Junção N:M)
CREATE TABLE public.colaborador_trilha (
    id_colab_trilha
BIGSERIAL NOT NULL,
    id_colaborador
BIGINT NOT NULL,
    id_trilha BIGINT
NOT NULL,
    status character
varying DEFAULT 'Liberada',
    created_at
timestamp with time zone NOT NULL DEFAULT now(),
    updated_at
timestamp with time zone NOT NULL DEFAULT now(),
    CONSTRAINT
colaborador_trilha_pkey PRIMARY KEY (id_colab_trilha),
    CONSTRAINT
ct_id_colaborador_fkey FOREIGN KEY (id_colaborador) REFERENCES
public.colaborador(id_colaborador) ON DELETE CASCADE,
    CONSTRAINT
ct_id_trilha_fkey FOREIGN KEY (id_trilha) REFERENCES public.trilha_carreira(id_trilha) ON DELETE CASCADE,
    UNIQUE (id_colaborador,
id_trilha)
);
CREATE TRIGGER trg_colaborador_trilha_updated_at
BEFORE UPDATE ON public.colaborador_trilha
FOR EACH ROW EXECUTE FUNCTION public.set_updated_at();
